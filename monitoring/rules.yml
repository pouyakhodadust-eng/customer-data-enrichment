# Alerting Rules
groups:
  - name: enrichment-alerts
    rules:
      # API alerts
      - alert: APIHighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High error rate on Enrichment API"
          description: "More than 5% of requests are returning 5xx errors"
          
      - alert: APILatencyHigh
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High API latency"
          description: "95th percentile latency is above 2 seconds"
          
      # Database alerts
      - alert: PostgresDown
        expr: pg_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQL is down"
          
      - alert: PostgresConnectionsHigh
        expr: pg_stat_activity_count / pg_settings_max_connections > 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQL connections near limit"
          
      # Redis alerts
      - alert: RedisDown
        expr: redis_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Redis is down"
          
      - alert: RedisMemoryHigh
        expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Redis memory usage high"
          
      # Lead processing alerts
      - alert: LeadEnrichmentFailures
        expr: rate(leads_enriched_total{status="failed"}[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High lead enrichment failure rate"
          
      - alert: NoNewLeads
        expr: increase(leads_created_total[1h]) == 0
        for: 2h
        labels:
          severity: warning
        annotations:
          summary: "No new leads in the last 2 hours"
          
      # n8n alerts
      - alert: N8NWorkflowFailing
        expr: n8n_workflow_failed_total > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "n8n workflow failures detected"
          
      # Business metrics alerts
      - alert: LeadScoreQualityLow
        expr: avg(lead_score_total) < 30
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "Average lead score quality is low"
          
      - alert: ConversionRateLow
        expr: rate(leads_converted_total[24h]) / rate(leads_created_total[24h]) < 0.05
        for: 24h
        labels:
          severity: warning
        annotations:
          summary: "Lead conversion rate below 5%"
